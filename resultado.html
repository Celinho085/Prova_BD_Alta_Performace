<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Resultado da Prova – Revisão NP1</title>
<style>
  :root{--bg:#0f172a;--card:#0b1222;--ink:#e5e7eb;--muted:#94a3b8;--ok:#22c55e;--bad:#f43f5e;--accent:#38bdf8}
  *{box-sizing:border-box} body{margin:0;background:#0a0f1f;color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.55}
  header{padding:20px 16px;background:linear-gradient(180deg,rgba(56,189,248,.08),rgba(34,197,94,.06));border-bottom:1px solid rgba(148,163,184,.2)}
  .wrap{max-width:1000px;margin:0 auto;padding:0 16px 64px}
  h1{margin:.2rem 0 0;font-size:1.6rem}.sub{color:var(--muted)}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.008));border:1px solid rgba(148,163,184,.2);border-radius:16px;padding:16px;margin:14px 0}
  .score{font-size:1.2rem;font-weight:800}
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.25);color:var(--muted);font-size:.85rem;margin-right:6px}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  button{border:1px solid rgba(148,163,184,.3);background:#0b1222;color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700}
  button.accent{background:linear-gradient(90deg,var(--accent),#0ea5e9);border:none;color:#04131c}
  .q-head{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .q-title{font-weight:700}
  .pill{padding:2px 8px;border-radius:999px;font-size:.8rem;border:1px solid rgba(148,163,184,.25)}
  .pill.ok{border-color:rgba(34,197,94,.5);color:var(--ok)}
  .pill.bad{border-color:rgba(244,63,94,.5);color:var(--bad)}
  .small{color:var(--muted);font-size:.9rem}
  pre{white-space:pre-wrap}
</style>
</head>
<body>
<header class="wrap">
  <h1>Resultado da Prova – Revisão NP1</h1>
  <div class="sub">Sua nota e feedback por questão. Você pode exportar por e-mail ou imprimir.</div>
</header>

<main class="wrap" id="app">
  <!-- preenchido via JS -->
</main>

<div class="wrap" style="position:sticky;bottom:0;padding:12px 16px;background:linear-gradient(180deg,rgba(10,15,31,.2),rgba(10,15,31,.95));backdrop-filter:blur(8px);border-top:1px solid rgba(148,163,184,.2)">
  <div class="row">
    <button id="voltar">Refazer prova</button>
    <button class="accent" id="enviarEmail">Exportar / Enviar por e-mail</button>
    <button id="imprimir">Imprimir / Salvar PDF</button>
  </div>
</div>

<script>
function render(){
  const root = document.getElementById('app');
  const raw = sessionStorage.getItem('prova_bd_result');
  if(!raw){
    root.innerHTML = `
      <div class="card">
        <div class="score">Não encontrei dados da tentativa.</div>
        <div class="small">Abra <strong>prova.html</strong>, responda e clique em Enviar.</div>
      </div>`;
    return;
  }
  const data = JSON.parse(raw);
  const {aluno,email,score,total,detalhes,discursivas} = data;
  const perc = ((score/total)*100).toFixed(1);

  let html = `
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div class="score">Aluno: ${aluno}</div>
          <div class="small">E-mail: ${email || '(não informado)'}</div>
        </div>
        <div>
          <span class="badge">Questões: ${total}</span>
          <span class="badge">Acertos: ${score}</span>
          <span class="badge">Nota (%): ${perc}%</span>
        </div>
      </div>
    </div>
  `;

  html += `<div class="card"><div class="q-title">Feedback por questão</div>`;
  detalhes.forEach((d,i)=>{
    const status = d.correto ? 'ok' : 'bad';
    const marcado = d.marcado ?? '(em branco)';
    html += `
      <div class="card" style="margin:12px 0">
        <div class="q-head">
          <div class="q-title">${i+1}. ${d.enunciado || d.id.toUpperCase()}</div>
          <div class="pill ${status}">${d.correto ? 'Correta' : 'Incorreta'}</div>
        </div>
        <div class="small">Você marcou: <strong>${marcado}</strong> &nbsp;|&nbsp; Gabarito: <strong>${d.gabarito}</strong></div>
      </div>
    `;
  });
  html += `</div>`;

  html += `
    <div class="card">
      <div class="q-title">Respostas Discursivas</div>
      <div class="small">Essas respostas não entram no cálculo automático, mas ficam registradas no relatório.</div>
      <h4>D1) Anomalias & 3FN</h4>
      <pre>${(discursivas?.d1 || '(em branco)').replace(/[<>&]/g, s => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))}</pre>
      <h4>D2) Metadados, Dicionário de Dados & DER</h4>
      <pre>${(discursivas?.d2 || '(em branco)').replace(/[<>&]/g, s => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))}</pre>
    </div>
  `;

  root.innerHTML = html;

  document.getElementById('voltar').onclick = ()=>{ window.location.href='prova.html'; };
  document.getElementById('imprimir').onclick = ()=> window.print();
  document.getElementById('enviarEmail').onclick = ()=>{
    const linhas = [];
    linhas.push(`Resultado – Revisão NP1`);
    linhas.push(`Aluno: ${aluno}`);
    linhas.push(`Nota: ${score}/${total} (${perc}%)`);
    linhas.push('');
    linhas.push('Objetivas:');
    detalhes.forEach((d,i)=>{
      const marcado = d.marcado ?? '(em branco)';
      const certo = d.correto ? 'OK' : 'ERRO';
      linhas.push(`${i+1}. ${d.id.toUpperCase()} – marcado=${marcado}; gabarito=${d.gabarito} [${certo}]`);
    });
    linhas.push('');
    linhas.push('Discursivas:');
    linhas.push(`D1) ${discursivas?.d1 || '(em branco)'}`);
    linhas.push(`D2) ${discursivas?.d2 || '(em branco)'}`);

    const body = encodeURIComponent(linhas.join('\n')).replace(/%0A/g,'%0D%0A');
    const subj = encodeURIComponent(`Resultado – Revisão NP1 (${score}/${total}) – ${aluno}`);
    const to = encodeURIComponent(email || '');
    window.location.href = `mailto:${to}?subject=${subj}&body=${body}`;
  };
}
render();
</script>
</body>
</html>
